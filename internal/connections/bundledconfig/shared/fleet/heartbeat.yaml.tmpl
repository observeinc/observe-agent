receivers:
  heartbeat:
    interval: {{.SelfMonitoring.Fleet.Interval}}
    config_interval: {{.SelfMonitoring.Fleet.ConfigInterval}}
    environment: ${env:OBSERVE_AGENT_ENVIRONMENT}
    auth_check:
      url: ${env:OBSERVE_COLLECTOR_URL}
      headers:
        authorization: ${env:OBSERVE_AUTHORIZATION_HEADER}
processors:
  resource/heartbeat:
    attributes:
    - key: observe.agent.hostname
      from_attribute: host.name
      action: insert
  transform/heartbeat:
    error_mode: ignore
    log_statements:
    - context: log
      statements:
        {{- if .HasResourceAttributes }}
        - set(attributes["observe_transform"]["identifiers"]["deployment.environment.name"], resource.attributes["deployment.environment.name"])
        {{- end }}
        - set(attributes["observe_transform"]["identifiers"]["host.name"], resource.attributes["host.name"])
        - set(attributes["observe_transform"]["identifiers"]["os.type"], resource.attributes["os.type"])
exporters:
  otlphttp/agentheartbeat:
      compression: zstd
      logs_endpoint: ${env:OBSERVE_COLLECTOR_URL}/v1/kubernetes/v1/entity
      headers:
          Authorization: ${env:OBSERVE_AUTHORIZATION_HEADER}
          X-Observe-Target-Package: Observe Agent
          X-Observe-Agent-Instance-Id: ${env:OBSERVE_AGENT_INSTANCE_ID}
          X-Observe-Context: {{ mustToJson (dict "version" (env "OBSERVE_AGENT_VERSION") "environment" (env "OBSERVE_AGENT_ENVIRONMENT")) | mustToYaml }}
          X-Observe-Enable-Auth-Error-Reporting: "true"
      retry_on_failure:
          enabled: true
      sending_queue:
          num_consumers: 4
          queue_size: 100
service:
  pipelines:
    logs/heartbeat:
      receivers: 
        - heartbeat
      processors:
        - resourcedetection
        {{- if .HasResourceAttributes }}
        - resource/observe_global_resource_attributes
        {{- end }}
        {{- if .HasAttributes }}
        - attributes/observe_global_attributes
        {{- end }}
        - resourcedetection/cloud
        - resource/agent_instance
        - resource/heartbeat
        - transform/heartbeat
      exporters:
        - otlphttp/agentheartbeat
